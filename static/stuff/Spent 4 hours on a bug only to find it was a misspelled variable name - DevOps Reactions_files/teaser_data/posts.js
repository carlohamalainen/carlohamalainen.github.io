(function(g,o){var j=Backbone.View.extend({el:"#posts",initialize:function(){this.collection=new l();this.form_key=g("#tumblr_form_key").attr("content");this.createPosts();o.AutoPaginator.on("after",this.createPosts.bind(this));o.Events.on("posts:load",this.createPosts.bind(this));o.Events.on("post:like",this.likePostById.bind(this));o.Events.on("post:fastreblog",this.fastReblogById.bind(this))},createPosts:function(){_.each(this.$el.find(".post:not(.new_post_buttons):not([data-view-exists])"),this.createPost.bind(this))},createPost:function(t,s){var p=g(t);var r=new d({id:p.attr("data-post-id"),type:p.attr("data-type"),root_id:p.attr("data-root-id"),tumblelog:p.attr("data-tumblelog-name"),tumblelog_key:p.attr("data-tumblelog-key"),reblog_key:p.attr("data-reblog-key"),is_mine:p.hasClass("is_mine"),accepts_answers:p.attr("data-accepts-answers"),following_tumblelog:p.attr("data-following-tumblelog"),reblogged:false,liked:p.find(".post_control.like").hasClass("liked"),form_key:this.form_key,sponsored:p.attr("data-sponsored")||false,featured_tags:(p.attr("data-featured-tags")||"").split(",")});this.collection.add(r);var q=c;if(o.isLoggedIn){if(r.get("type")=="fan_mail"){q=k}}else{q=f}new q({el:p,model:r});p.attr("data-view-exists",true)},likePostById:function(q,p){p=p||"mouse";this.collection.get(q).like(p)},fastReblogById:function(q,p){this.collection.get(q).fastReblog(p)}});var l=Backbone.Collection.extend({model:d,initialize:function(){this.on("change:liked",this.updateLikeStatus.bind(this));this.on("ignore:success",this.dismiss.bind(this));this.on("unfollow:success",this.dismiss.bind(this))},updateLikeStatus:function(p,q){var r=this.whereBy({liked:!q,root_id:p.get("root_id")});r.invoke("set",{liked:q});if(p.get("liked")){r.invoke("trigger","like:success")}else{r.invoke("trigger","unlike:success")}},dismiss:function(p){this.whereBy({tumblelog:p.get("tumblelog"),sponsored:false}).invoke("dismiss")},whereBy:function(p){return new l(this.where(p))}});var d=Backbone.Model.extend({likePayload:function(p){p=p||"mouse";return{id:this.get("id"),key:this.get("reblog_key"),method:p}},like:function(p){if(this.get("is_mine")){return}this.trigger("like:success",this);if(!this.get("liked")){this.set("liked",true);o.like(this.likePayload(p)).error(this.trigger.bind(this,"like:failure"))}},xhr_request:function(p,s,q){s=_.extend(s,{form_key:this.get("form_key")});var r=g.ajax({data:JSON.stringify(s),type:"POST",url:p});r.done(_.bind(function(t){if(q[200]){q[200].call(this,t)}},this));r.fail(_.bind(function(v,t,u){if(q[v.status]){q[v.status].call(this,v.status)}},this))},unlike:function(){this.set("liked",false);this.trigger("unlike:success",this);o.unlike(this.likePayload()).error(this.trigger.bind(this,"unlike:failure"))},toggleLike:function(){if(this.get("liked")){this.unlike()}else{this.like()}},reblog:function(){if(this.get("reblogged")){return}this.set("reblogged",true);return g.ajax({url:"/fast_reblog",type:"post",data:{reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),form_key:g("#tumblr_form_key").attr("content")},success:function(){this.set("reblogged",true)}.bind(this),error:function(){this.set("reblogged",false)}.bind(this)})},fastReblog:function(p){p=p||false;this.trigger("fastreblog:success",p);this.set("reblogged",true);return g.ajax({url:"/fast_reblog",type:"post",data:{reblog_key:this.get("reblog_key"),reblog_post_id:this.get("id"),form_key:g("#tumblr_form_key").attr("content"),queue:p},success:function(){this.set("reblogged",true)}.bind(this),error:function(){this.set("reblogged",false)}.bind(this)})},reply:function(q){var p=o.reply({reply_text:q,post_id:this.get("id"),tumblelog:this.get("tumblelog"),tumblelog_key:this.get("tumblelog_key")});p.done(function(){this.trigger("replied")}.bind(this));return p},destroy:function(){var p={post_id:this.get("id"),channel_id:this.get("tumblelog")};this.xhr_request("/svc/post/delete",p,{200:this.trigger.bind(this,"destroy:success"),401:this.trigger.bind(this,"destroy:failure"),403:this.trigger.bind(this,"destroy:failure"),500:this.trigger.bind(this,"destroy:failure"),})},toggle_spam_tumblelog:function(){var p=g.ajax({url:"/spam/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});p.fail(this.trigger.bind(this,"spam_toggle:failure"));p.done(this.trigger.bind(this,"spam_toggle:success"));return p},toggle_nsfw_tumblelog:function(){var p=g.ajax({url:"/nsfw/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});p.fail(this.trigger.bind(this,"nsfw_toggle:failure"));p.done(this.trigger.bind(this,"nsfw_toggle:success"));return p},toggle_adult_tumblelog:function(){var p=g.ajax({url:"/adult/toggle",type:"post",data:{tumblelog:this.get("tumblelog"),form_key:this.get("form_key")}});p.fail(this.trigger.bind(this,"adult_toggle:failure"));p.done(this.trigger.bind(this,"adult_toggle:success"));return p},toggle_follow:function(r){var p;var q={tumblelog:this.get("tumblelog"),source:r};if(this.get("following_tumblelog")){this.set("following_tumblelog",false);p=o.unfollow(q);p.done(this.trigger.bind(this,"unfollow:success",this));p.fail(this.trigger.bind(this,"unfollow:failure",this))}else{this.set("following_tumblelog",true);p=o.follow(q);p.done(this.trigger.bind(this,"follow:success",this));p.fail(this.trigger.bind(this,"follow:failure",this))}return p},fan_mail:function(){if(_.isObject(o.FanMail)){var p={href:o.FanMail.make_url_from_tumblelog(this.get("tumblelog"))};o.FanMail.show(p)}},publish:function(){var p=g.ajax({url:"/publish",type:"post",data:{form_key:this.get("form_key"),id:this.get("id")}});p.fail(this.trigger.bind(this,"publish:failure"));p.done(this.trigger.bind(this,"publish:success"))},promote:function(p){var q=g.ajax({url:"/svc/promote",type:"post",data:{tag:p,post_id:this.get("id"),form_key:this.get("form_key"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")}});q.fail(this.trigger.bind(this,"promote:failure"));q.done(function(r){if(r&&r.status&&r.status=="failure"){this.trigger("promote:failure",r.error)}else{this.trigger("promote:success",p)}}.bind(this));return q},unpromote:function(p){var q=g.ajax({url:"/svc/unpromote",type:"post",data:{tag_id:p,post_id:this.get("id"),form_key:this.get("form_key"),reblog_key:this.get("reblog_key"),tumblelog_name:this.get("tumblelog")}});q.fail(this.trigger.bind(this,"unpromote:failure"));q.done(this.trigger.bind(this,"unpromote:success"));return q},follow:function(q,p){q=q||this.get("tumblelog");o.follow({tumblelog:q,source:p},{success:g.proxy(function(){o.Events.trigger("follow_tumblelog",{tumblelog:q});this.trigger("follow:success",this)},this),error:g.proxy(function(){this.trigger("follow:failure",this)},this)})},ignore:function(q){q=q||this.get("tumblelog");var p=o.ignore({tumblelog:q});p.done(function(){o.Events.trigger("block_tumblelog",{tumblelog:q,can_report:true});this.trigger("ignore:success",this)}.bind(this));p.fail(this.trigger.bind(this,"ignore:failure"))},queue:function(){var p=g.ajax({url:"/publish",type:"post",data:{form_key:this.get("form_key"),id:this.get("id"),queue:"queue"}});p.fail(this.trigger.bind(this,"queue:failure"));p.done(this.trigger.bind(this,"queue:success"))},removeSource:function(){var p=g.ajax({url:"/remove_app_attribution",type:"post",dataType:"text",data:{post_id:this.get("id"),tumblelog_id:this.get("tumblelog"),form_key:this.get("form_key")}});p.done(this.trigger.bind(this,"remove_source:success"));p.fail(this.trigger.bind(this,"remove_source:failure"));return p},dismiss:function(){this.trigger("dismiss",this)},approve:function(p){var r={form_key:this.get("form_key"),id:this.get("id")};if(p){r.queue=true}var q=g.ajax({url:"/approve_submission/"+this.get("id"),type:"post",dataType:"text",data:r});q.fail(this.trigger.bind(this,"approve:failure"));q.done(this.trigger.bind(this,"approve:success"));return q},deny:function(){var p=g.ajax({url:"/deny_submission",type:"post",dataType:"text",data:{pid:this.get("id"),form_key:this.get("form_key")}});p.fail(this.trigger.bind(this,"deny:failure"));p.done(this.trigger.bind(this,"deny:success"));return p},answer:function(q){var p=g.ajax({url:"/answer",type:"post",data:{form_key:this.get("form_key"),post_id:this.get("id"),tumblelog:this.get("tumblelog"),key:this.get("tumblelog_key"),answer_text:q}});p.fail(this.trigger.bind(this,"answer:failure"));p.done(this.trigger.bind(this,"answer:success"));return p}});var i=o.PopoverWithForm.extend({template:"#post_reply_form",initialize:function(p){var q=_.template(g(this.template).html());this.$el.html(q());this.submit_button=this.$("button");this.textarea=this.$("form textarea");this.check_form_state();this.textarea.on("input",_.bind(this.check_form_state,this));this.textarea.on("keyup",_.bind(this.check_form_state,this));_.extend(this.options,{on_hide:this.on_hide,on_show:this.on_show});o.PopoverWithForm.prototype.initialize.apply(this,arguments)},check_form_state:function(){this.submit_button.attr("disabled",this.textarea[0].value.length===0)},on_show:function(){this.position()},on_hide:function(){this.$el.removeClass("active")},submit_form:function(q){q.preventDefault();this.submit_button.attr("disabled",true);this.submit_button.html(this.submit_button.data("label-loading"));var p=this.model.reply(this.textarea.val());p.done(this.on_success.bind(this))},on_success:function(){this.model.set("replied_to",true);this.trigger("success");this.$el.find("button").attr("disabled",false);this.$el.find("textarea").val("");this.hide();this.submit_button.html(this.submit_button.data("label"))}});var e=o.Popover.extend({events:{"click .post_control.delete":"delete","click .post_control.edit":"edit","click .post_control.queue":"queue"},initialize:function(p){_.extend(this.options,{on_show:this.on_show,disable_auto_show:true});o.Popover.prototype.initialize.apply(this,arguments)},"delete":function(p){this.hide();this.$el.removeClass("active")},edit:function(p){this.hide();this.$el.removeClass("active");this.trigger("action:edit")},queue:function(p){this.hide()},on_show:function(){this.position()}});var a=Backbone.View.extend({events:{"click .promote_post a":"promote","change select.promotable_tags":"promote_select"},button_count:5,initialize:function(p){this.model.on("promote:success",this.update_tag_count.bind(this));this.render()},render:function(){this.$el.html(this.template())},promote:function(r){var p=g(r.currentTarget);var q=this.model.promote(p.data("tag"));p.addClass("loading");q.always(p.removeClass.bind(p,"loading"));if(o.Popover){o.Popover.hide_all()}},update_tag_count:function(p){for(var q=0;q<promotable_tags.length;q++){if(promotable_tags[q].title==p.title){promotable_tags[q].promote_diff-=1}}},promote_select:function(r){var p=g(r.currentTarget);var q=this.model.promote(p.val());if(o.Popover){o.Popover.hide_all()}},show:function(p){this.$el.show();this.$el.removeClass("hidden")},hide:function(p){this.$el.hide();this.$el.addClass("hidden")},template:function(){var p=_.compact(this.$el.data("promotion-warnings").split(";;"));var q="";q+="<ul>";q+='<li class="popover_sub_header promote_post_header">Promote</li>';if(promotable_tags.length>this.button_count){q+='<div class="promote_select_wrapper">';q+='<select class="popover_menu_item promotable_tags">';q+='<option value="">'+l10n_str.promote_this_post_in+"</option>"}_.each(promotable_tags,function(r,t){var s=(r.promote_diff<0)?"":" ("+r.promote_diff+")";if(r.promote_diff===0){p.push(l10n_str.promote_warning_none.replace("%1$s",r.title))}if(promotable_tags.length>this.button_count){q+='<option value="'+r.tag+'">'+promotable_tags[t].title+s+"</option>"}else{q+='<li class="popover_menu_item promote_post">';q+='<a data-tag="'+r.tag+'" href="#">';q+=promotable_tags[t].title+s;q+="</a>";q+="</li>"}},this);if(promotable_tags.length>this.button_count){q+="</select>";q+="</div>"}if(p.length){q+='<div class="promote_pane_warnings>';_.each(p,function(r){q+='<div class="warning">'+r+"</div>"});q+="</div>"}q+="</ul>";return q}});var b=o.Popover.extend({events:{"click .post_control.unpromote":"unpromote","click .post_control.remove_source":"remove_source"},initialize:function(p){_.extend(this.options,{on_show:this.on_show,on_hide:this.on_hide,disable_auto_show:true});if(window.promotable_tags){this.promote_tag_view=new a({el:this.$(".promote_pane"),model:this.model,tags:promotable_tags});this.promote_tag_view.show()}this.model.on("remove_source:failure",this.error.bind(this));o.Popover.prototype.initialize.apply(this,arguments)},on_show:function(){this.position()},remove_source:function(){this.hide();this.model.removeSource()},on_hide:function(){},error:function(){o.Dialog.alert("Error removing source from this post")},promote:function(p){p.preventDefault();if(!(this.promote_tag_view instanceof a)){this.promote_tag_view=new a({el:this.$(".promote_pane"),model:this.model,tags:promotable_tags})}this.promote_tag_view.show()},unpromote:function(r){var p=g(r.currentTarget);var q=this.model.unpromote(p.data("tag"));p.addClass("loading");q.always(p.removeClass.bind(p,"loading"))},});var h=o.Popover.extend({initialize:function(p){_.extend(this.options,{on_show:this.on_show,on_hide:this.on_hide,disable_auto_show:false});this.model.on("nsfw_toggle:success",this.toggle_nsfw_class.bind(this));this.model.on("adult_toggle:success",this.toggle_adult_class.bind(this));this.model.on("spam_toggle:success",this.toggle_spam_class.bind(this));this.model.on("unfollow:success",this.toggle_follow_class.bind(this));this.model.on("follow:success",this.toggle_follow_class.bind(this));this.$el.on("click",".user_menu_toggle_spam",this.toggle_spam.bind(this));this.$el.on("click",".user_menu_toggle_nsfw",this.toggle_nsfw.bind(this));this.$el.on("click",".user_menu_toggle_adult",this.toggle_adult.bind(this));this.$el.on("click",".user_menu_toggle_follow",this.toggle_follow.bind(this));this.$el.on("click",".fan_mail",this.fan_mail.bind(this));o.Popover.prototype.initialize.apply(this,arguments)},on_show:function(){this.position();this.$el.addClass("active")},on_hide:function(){this.$el.removeClass("active")},fan_mail:function(p){if(_.isObject(o.FanMail)){p.preventDefault();this.hide();this.model.fan_mail()}},toggle_spam:function(p){p.preventDefault();this.hide();this.model.toggle_spam_tumblelog()},toggle_nsfw:function(p){p.preventDefault();this.hide();this.model.toggle_nsfw_tumblelog()},toggle_adult:function(p){p.preventDefault();this.hide();this.model.toggle_adult_tumblelog()},toggle_follow:function(p){p.preventDefault();this.hide();this.model.toggle_follow("FOLLOW_SOURCE_DASHBOARD")},toggle_spam_class:function(){this.$(".user_menu_toggle_spam").toggleClass("is_spam")},toggle_nsfw_class:function(){this.$(".user_menu_toggle_nsfw").toggleClass("is_nsfw")},toggle_adult_class:function(){this.$(".user_menu_toggle_adult").toggleClass("is_adult")},toggle_follow_class:function(){this.$(".user_menu_toggle_follow").toggleClass("follow").toggleClass("unfollow")}});var c=Backbone.View.extend({events:{"click .post_control.like:not(.liked)":"like","click .post_control.liked":"unlike","click .post_control.reblog":"reblog","click .post_control.reply":"reply","click .post_control.block":"ignore","click .post_control.publish":"publish","click .post_control.queue":"queue","click .post_control.queue_submission":"queue_submission","click .post_control.delete":"delete","click .post_control.approve":"approve","click .post_control.post_control_menu.creator":"creator_popover","click .post_control.post_control_menu.admin":"admin_popover","click .tumblelog_menu_button":"user_popover","touchend .tumblelog_menu":"user_popover","click .post_control.deny":"deny","click .note .follow":"follow"},initialize:function(){this.controls={};this.controls.like=this.$el.find(".post_control.like");this.controls.reblog=this.$el.find(".post_control.reblog");this.note_count=this.$el.find(".note_count");this.tagsDraggable();if(this.model.get("accepts_answers")){this.setupAnswerForm()}this.like_heart_timeout=null;this.is_click_trigger=false;this.is_reblogged=false;this.model.on("like:success",this.updateLikeStatus.bind(this,true));this.model.on("unlike:success",this.updateLikeStatus.bind(this,false));this.model.on("like:success",this.updateNoteCount.bind(this,true));this.model.on("unlike:success",this.updateNoteCount.bind(this,false));this.model.on("destroy:success",this.destroy.bind(this));this.model.on("dismiss",this.destroy.bind(this));this.model.on("publish:success",this.destroy.bind(this));this.model.on("queue:success",this.destroy.bind(this));this.model.on("unpromote:success",this.destroy.bind(this));this.model.on("promote:failure",this.alert.bind(this));this.model.on("deny:success",this.destroy.bind(this));this.model.on("approve:success",this.destroy.bind(this));this.model.on("answer:success",this.answer.bind(this));this.model.on("fastreblog:success",this.updateReblog.bind(this));this.model.on("remove_source:success",this.hidePost.bind(this));this.current_link=true;this.less_link=false;this.more_link=false},edit:function(){if(!o.PostForms){return}event.preventDefault();o.PostForms.edit({type:this.model.get("type"),edit:true,channel_id:this.model.get("tumblelog"),post_id:this.model.get("id"),endpoint:this.model.get("type"),attach_to:this.$el,previous_content_selector:this.$(".post_wrapper"),adjust_offset:true})},"delete":function(q){q.preventDefault();var p=g(q.currentTarget).data("confirm");o.Dialog.confirm(p,this.model.destroy.bind(this.model))},deny:function(q){q.preventDefault();var p=g(q.currentTarget).data("confirm");o.Dialog.confirm(p,function(){this.destroy();this.model.deny()}.bind(this))},approve:function(q){q.preventDefault();var p=g(q.currentTarget).data("confirm");o.Dialog.confirm(p,this.model.approve.bind(this.model,false))},queue:function(q){q.preventDefault();var p=g(q.currentTarget).data("confirm");o.Dialog.confirm(p,this.model.queue.bind(this.model))},queue_submission:function(q){q.preventDefault();var p=g(q.currentTarget).data("confirm");o.Dialog.confirm(p,this.model.approve.bind(this.model,true))},creator_popover:function(p){if(p.target!=p.currentTarget){return}var q=g(p.currentTarget);if(!(this.creatorPopover instanceof e)){this.creatorPopover=new e({model:this.model,el:g(p.target),on_hide:function(){q.removeClass("active")}.bind(this)});this.creatorPopover.on("action:edit",this.edit.bind(this))}q.addClass("active");this.creatorPopover.show()},admin_popover:function(p){if(p.target!=p.currentTarget){return}if(!(this.adminPopover instanceof b)){this.adminPopover=new b({model:this.model,el:g(p.target)})}this.adminPopover.show()},user_popover:function(q){var p=(q.type=="touchend");if(p){q.preventDefault();q.stopPropagation();this.$el.off("click",".tumblelog_menu_button")}if(!(this.userPopover instanceof h)){var r=this.$(q.currentTarget);this.userPopover=new h({model:this.model,el:p?r:r.closest(".tumblelog_menu"),popover:p?r.find(".popover"):r.siblings(".popover")})}this.userPopover.show()},like:function(p){p.preventDefault();this.is_click_trigger=true;this.model.like("mouse")},unlike:function(p){p.preventDefault();this.is_click_trigger=true;this.model.unlike()},reply:function(p){var q=g(p.currentTarget);if(!(this.replyPopover instanceof i)){this.replyPopover=new i({model:this.model,el:q});this.replyPopover.on("success",function(){q.addClass("replied")});this.replyPopover.on("close",function(){q.removeClass("active")})}q.addClass("active");this.replyPopover.show()},publish:function(q){q.preventDefault();var p=g(q.currentTarget).data("confirm");o.Dialog.confirm(p,this.model.publish.bind(this.model))},reblog:function(p){if(p.altKey&&!this.model.reblogged){p.preventDefault();this.is_click_trigger=true;return this.fastReblog(p)}if(this.is_reblogged||!o.PostForms){return}p.preventDefault();this.is_click_trigger=true;o.PostForms.edit({type:this.model.get("type"),channel_id:this.model.get("tumblelog"),reblog_id:this.model.get("id"),endpoint:this.model.get("type"),detached:true,reblog:true,animate_from:this.$el,reblog_key:this.model.get("reblog_key"),previous_content_selector:null})},fastReblog:function(p){p.stopPropagation();p.preventDefault();if(!this.is_reblogged){this.model.fastReblog()}},follow:function(r){r.preventDefault();var q=g(r.currentTarget);var p=q.closest(".note");var s=p.data("tumblelog");p.addClass("is_following");this.model.follow(s)},ignore:function(r){r.preventDefault();var p=g(r.currentTarget);var q=p.data("confirm");var s=p.data("block");if(s){o.Dialog.confirm(q,this.model.ignore.bind(this.model,s))}else{o.Dialog.confirm(q,this.model.ignore.bind(this.model))}},hidePost:function(p){this.$el.fadeOut("fast")},updateReblog:function(p){this.is_reblogged=true;var r=g('<div class="post_reblog_poof post_poof"></div>'),q=this.controls.reblog;if(p){r.addClass("queue")}if(this.is_click_trigger){q.append(r)}else{if(this.$el.height()>g(window).height()){r.css("top",g(window).height()*0.5)}this.$el.append(r)}this.is_click_trigger=false;setTimeout(function(){r.fadeOut(200,function(){r.remove();q.addClass("reblogged");if(p){q.addClass("queued")}})},300)},updateLikeStatus:function(q){this.controls.like.toggleClass("liked",q);var p=g('<div class="post_animated_heart post_poof"><span class="heart_left"></span><span class="heart_right"></span></div>').toggleClass("unliked",!q);if(this.is_click_trigger){this.controls.like.append(p)}else{if(this.$el.height()>g(window).height()){p.css("top",g(window).height()*0.5)}if(g(".post_animated_heart").length>0){var r=0.2+(Math.random()*0.6);p.css("left",this.$el.width()*r)}this.$el.append(p)}this.is_click_trigger=false;setTimeout(function(){p.fadeOut(200,function(){p.remove()})},300)},updateNoteCount:function(q){var p=this.$(".note_link_current"),r;if(q){r=p.data("more");p.data("less",p.text());this.$el.removeClass("no_notes")}else{r=p.data("less");if(!r.length){this.$el.addClass("no_notes")}}p.text(r);p.attr("title",r)},destroy:function(){this.$el.fadeOut(500,function(){this.unbind();this.$el.parent().remove();o.Events.trigger("DOMEventor:updateRect");this.remove()}.bind(this))},alert:function(p){alert(p)},tagsDraggable:function(){var p=this.$(".post_tags");var q=p.find(".post_tags_inner");if(p.width()<q.width()){p.addClass("draggable no_pop");new n({el:p})}},setupAnswerForm:function(){var p=this.$(".post_answer");if(!(this.answer_form instanceof m)&&p.find(".post_answer_input").length){this.answer_form=new m({model:this.model,el:p,existing_note:this.$el.hasClass("existing_note")})}},answer:function(){this.$el.addClass("existing_note")}});var f=c.extend({events:{"click .post_control.like":"send_to_signup","click .post_control.reblog":"send_to_signup"},send_to_signup:function(p){if(p){p.preventDefault();p.stopPropagation()}window.open("/register");return false}});var k=c.extend({events:{'click [data-action="ignore"]':"ignore",'click [data-action="read_more"]':"read_more",'click [data-action="deny"]':"deny",'click [data-action="reply"]':"reply"},read_more:function(p){p.preventDefault();this.$(".read_more").hide();this.$(".message_body_truncated").hide();this.$(".message_body").show()},reply:function(p){p.preventDefault();o.FanMail.show(p.target)},deny:function(p){c.prototype.deny.call(this,p)}});o.Notes=Backbone.View.extend({initialize:function(){},el:"#posts",loading_notes:false,events:{"click .post_notes_label.note_count":"toggle_notes","click .more_notes_link":"on_more_click"},create_note_views:function(p){p.find(".note:not([data-view-exists])").each(function(r,t){if(g(t).hasClass("reblog")){var s=new o.ReblogNoteView({el:t})}else{var q=new o.NoteView({el:t})}g(t).attr("data-view-exists",true)})},toggle_notes:function(s){s.preventDefault();if(this.loading_notes){return}this.loading_notes=true;var r=g(s.currentTarget);var p=r.closest(".post");var q=p.find(".notes_container");if(q.is(":visible")){this.loading_notes=true;q.slideUp(300,_.bind(function(){o.Events.trigger("DOMEventor:updateRect");this.loading_notes=false;p.removeClass("showing_notes")},this));return}else{if(r.attr("data-notes-loaded")){p.addClass("showing_notes");this.animate_in(q);return}else{p.addClass("loading_notes");this.load_notes(p,{},_.bind(function(u,v,t){p.addClass("showing_notes");p.removeClass("loading_notes");r.attr("data-notes-loaded",true);this.animate_in(q)},this))}}},updateControls:function(q,r){var p=q.find(".more_notes_link");if(r){q.show();p.attr("data-next",r).show()}else{p.attr("data-notes-complete",true);q.hide()}},animate_in:function(p){this.loading_notes=true;p.slideDown(300,_.bind(function(){this.loading_notes=false},this))},on_more_click:function(p){p.preventDefault();this.more_notes(g(p.currentTarget).closest(".post"))},more_notes:function(p){$post=g(p);$link=$post.find(".more_notes_link").hide();$loading=$post.find(".notes_loading").show();this.loading_notes=true;this.load_notes($post,{from_id:$link.attr("data-next")},_.bind(function(r,s,q){$loading.hide();$link.show();this.loading_notes=false},this))},load_notes:function(p,r,s){var q="/dashboard/notes/"+p.attr("data-post-id")+"/"+p.attr("data-tumblelog-key");if(r.from_id){q+="?from_c="+r.from_id}g.ajax(q).done(_.bind(function(y,z,w){var v=p.find(".more_notes_link_container"),t=p.find(".notes"),u=p.find(".more_notes_link"),x=p.find(".notes_loading");u.show();x.hide();this.updateControls(v,w.getResponseHeader("X-next-note"));t.append(g(y).children());this.create_note_views(t);o.Events.trigger("DOMEventor:updateRect");s(y,z,w)},this))}});var n=Backbone.View.extend({initialize:function(){this.dragging=false;this.drag_x=false;this.drag_inner=this.$(".post_tags_inner");this.doc=g(document);this.d=this.getDimensions();this.transform=this.isTransformSupported();this.bindEvents()},bindEvents:function(){this.$el.on("mousedown touchstart touchmove mouseleave mouseup touchend",".post_tags_inner",_.bind(this.dragEvents,this));this.$el.on("click",".post_tag",_.bind(this.handleLinks,this))},getDimensions:function(){var q=this.$el.width();var p=this.drag_inner.width();return{post_width:q,tag_width:p,max_left:0,max_right:((q-p)-10)}},isTransformSupported:function(){var q="transform WebkitTransform MozTransform OTransform msTransform".split(" ");for(var p=0;p<q.length;p++){if(document.createElement("div").style[q[p]]!==undefined){return true}}return false},dragEvents:function(p){switch(p.type){case"mousedown":case"touchstart":this.dragStart(p);break;case"mousemove":case"touchmove":if(this.pointer_down){this.dragMove(p)}break;case"touchend":case"mouseup":this.dragEnd(p);break}},bindDocEvents:function(){this.doc.on("mousemove.tagsDraggable",_.bind(this.dragEvents,this));this.doc.on("mouseup.tagsDraggable",_.bind(this.resetDrag,this))},unbindDocEvents:function(){this.doc.off("mousemove.tagsDraggable");this.doc.off("mouseup.tagsDraggable")},dragStart:function(p){p.preventDefault();if(!this.dragging&&!this.pointer_down){this.pointer_down=true;this.start_x=this.drag_inner.position().left;this.page_x=p.pageX||p.originalEvent.touches[0].pageX;this.bindDocEvents()}},dragMove:function(p){p.preventDefault();p.stopPropagation();this.drag_inner[0].classList.add("dragging");this.dragging=true;p.clientX=p.clientX||p.originalEvent.touches[0].clientX;var q=p.clientX-this.page_x;this.drag_x=q+this.start_x;this.dragSet(this.drag_x)},dragSet:function(p){if(this.transform){this.drag_inner.css("transform","translate("+p+"px, 0)")}else{this.drag_inner.css("left",p)}},handleLinks:function(p){p.preventDefault();p.stopPropagation();if(!this.dragging){window.open(g(p.currentTarget).attr("href"),"_blank")}return false},resetDragPosition:function(){if(this.drag_x>this.d.max_left){this.dragSet(this.d.max_left)}else{if(this.drag_x<this.d.max_right){this.dragSet(this.d.max_right)}}},dragEnd:function(){event.preventDefault();event.stopPropagation();var p=_.bind(this.resetDrag,this);_.delay(p,100)},resetDrag:function(){if(this.dragging||this.pointer_down){this.dragging=false;this.pointer_down=false;this.drag_inner[0].classList.remove("dragging");this.resetDragPosition();this.unbindDocEvents()}}});var m=Backbone.View.extend({events:{"keyup .post_answer_input":"keyup","focus .post_answer_input":"focus","blur  .post_answer_input":"blur","click .post_answer_submit":"submit"},initialize:function(){this.max_length=140;this.answer_input=this.$(".post_answer_input");this.answer_submit=this.$(".post_answer_submit");this.answer_length=this.$(".post_answer_length");this.answer_error_message=this.answer_input.data("error-message");this.existing_note=this.options.existing_note||false;this.answer_text=this.answer_input.val();this.model.on("answer:success",this.answer.bind(this));this.model.on("answer:failure",this.error.bind(this))},keyup:function(p){if(this.existing_note){return false}this.remaining_chars=this.max_length-this.getAnswerLength();if(this.remaining_chars<=0){this.remaining_chars=0}this.answer_length.text(this.remaining_chars);this.answer_text=(this.answer_text!==this.answer_input.val())?this.answer_input.val():this.answer_text;if(p.keyCode==13){p.preventDefault();this.answer_post()}},focus:function(p){if(this.existing_note){return false}this.answer_text=this.answer_input.val();this.$el.addClass("show_submit")},blur:function(p){if(this.getAnswerLength()==0){this.$el.removeClass("show_submit")}},submit:function(p){p.preventDefault();this.answer_post()},answer_post:function(){if(this.getAnswerLength()){this.model.answer(this.getAnswer())}},answer:function(){this.answer_input.blur();this.answer_input.attr("readonly","readonly")},error:function(){o.Dialog.confirm(this.answer_error_message)},getAnswerLength:function(){return this.getAnswer().length},getAnswer:function(){return g.trim(this.answer_input.val())}});o.Posts=j})(jQuery,Tumblr);jQuery(document).ready(function(a){new Tumblr.Posts();if(Tumblr&&Tumblr.Capture){Tumblr.CaptureWebInStream=new Tumblr.Capture.WebInStream()}});