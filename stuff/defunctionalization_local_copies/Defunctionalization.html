<meta http-equiv="Content-type" content="text/html; charset=utf-8" />

<p>What is defunctionalization?</p>
<!--
This article original published at http://kennknowles.com/blog

Copyright 2008 Kenneth Knowles

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
 
    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<p>I recently gave a little demonstration entitled “What is Defunctionalization?” for UCSC TWIGS (the acronym, stolen from a similar seminar in the the U. Mass. math department, stands for The “What Is … ?” Graduate Seminar). The inspiration for this talk was just to present what I’d learned after Conor McBride’s brilliant presentation at POPL’08 drove me to put the words “Olivier Danvy defunctionalize continuation” into Google.</p>
<p>I coded the simplest examples from</p>
<ul>
<li>Defunctionalization at work. O Danvy, LR Nielsen. PPDP 2001.</li>
</ul>
<p>in literate Haskell for the audience, and also showed off QuickCheck a little to make sure the translation was correct (finding one error, if I recall).</p>
<p>This blog post is a merging of my talk outline and new stuff that came up live. Try loading it up in GHCi or Haskell-mode and running the examples and QuickCheck properties.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: green;">{-# LANGUAGE RankNTypes #-}</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span> <span style="">Prelude</span> <span style="">hiding</span> <span style="color: red;">(</span><span style="">reverse</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span> <span style="">Control</span><span style="">.</span><span style="">Monad</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span> <span style="">Control</span><span style="">.</span><span style="">Monad</span><span style="">.</span><span style="">Cont</span>
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">import</span> <span style="">Test</span><span style="">.</span><span style="">QuickCheck</span>
</code></pre>
<p>Broadly, defunctionalization is transforming a program to eliminate higher-order functions. Rather than focus on its use for compilation (see this H Cejtin, S Jagannathan, S Weeks paper on MLTon) or analyses (see Firstify from N Mitchell and C Runciman). I wanted to emphasize its use in understanding your own program, along the lines of Wand’s Continuation-Based Program Transformation Strategies (JACM 1980).</p>
<p>Here is the first example from Danvy.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">aux1</span> <span style="color: red;">::</span> <span style="color: red;">(</span><span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">aux1</span> <span style="">f</span> <span style="color: red;">=</span> <span style="">f</span> <span class="hs-num">1</span> <span style="">+</span> <span style="">f</span> <span class="hs-num">10</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">main1</span> <span style="">x</span> <span style="">y</span> <span style="">b</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">aux1</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">z</span> <span style="color: red;">-&gt;</span> <span style="">x</span> <span style="">+</span> <span style="">z</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">*</span> 
<span style="">&gt;</span>               <span style="color: red;">(</span><span style="">aux1</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">z</span> <span style="color: red;">-&gt;</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">b</span> <span style="color: blue; font-weight: bold;">then</span> <span style="">y</span> <span style="">+</span> <span style="">z</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">y</span> <span style="color: green;">-</span> <span style="">z</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>Defunctionalization replaces all the first-class functions with an explicit data structure Lam1 and a global apply1 function, essentially embedding a mini-interpreter for just those lambda terms occurring in the program.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">Lam1</span> <span style="color: red;">=</span> <span style="">Lam1A</span> <span style="">Int</span>      <span style="color: green;">-- (Lam1A x)   ~ (\z -&gt; x + z)</span>
<span style="">&gt;</span>           <span style="color: red;">|</span> <span style="">Lam1B</span> <span style="">Int</span> <span style="">Bool</span> <span style="color: green;">-- (Lam1B y b) ~ (\z -&gt; if b then y + z else y - z)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">apply1</span> <span style="color: red;">::</span> <span style="">Lam1</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">apply1</span> <span style="color: red;">(</span><span style="">Lam1A</span> <span style="">x</span><span style="color: red;">)</span>   <span style="">z</span> <span style="color: red;">=</span> <span style="">x</span> <span style="">+</span> <span style="">z</span>
<span style="">&gt;</span> <span style="">apply1</span> <span style="color: red;">(</span><span style="">Lam1B</span> <span style="">y</span> <span style="">b</span><span style="color: red;">)</span> <span style="">z</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">if</span> <span style="">b</span> <span style="color: blue; font-weight: bold;">then</span> <span style="">y</span> <span style="">+</span> <span style="">z</span> <span style="color: blue; font-weight: bold;">else</span> <span style="">y</span> <span style="color: green;">-</span> <span style="">z</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">aux1defun</span> <span style="color: red;">::</span> <span style="">Lam1</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">aux1defun</span> <span style="">f</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">apply1</span> <span style="">f</span> <span class="hs-num">1</span><span style="color: red;">)</span> <span style="">+</span> <span style="color: red;">(</span><span style="">apply1</span> <span style="">f</span> <span class="hs-num">10</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">main1defun</span> <span style="">x</span> <span style="">y</span> <span style="">b</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">aux1defun</span> <span style="color: red;">(</span><span style="">Lam1A</span> <span style="">x</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">*</span>
<span style="">&gt;</span>                    <span style="color: red;">(</span><span style="">aux1defun</span> <span style="color: red;">(</span><span style="">Lam1B</span> <span style="">y</span> <span style="">b</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>Is it correct? Ask quickcheck:</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">prop1</span> <span style="">x</span> <span style="">y</span> <span style="">b</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">main1</span> <span style="">x</span> <span style="">y</span> <span style="">b</span> <span style="">==</span> <span style="">main1defun</span> <span style="">x</span> <span style="">y</span> <span style="">b</span><span style="color: red;">)</span>
</code></pre>
<p>*Main&gt; quickCheck prop1 +++ OK, passed 100 tests.</p>
<p>Next example: flattening a binary tree</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">BinaryTree</span> <span style="">a</span> <span style="color: red;">=</span> <span style="">Leaf</span> <span style="">a</span>
<span style="">&gt;</span>                   <span style="color: red;">|</span> <span style="">Node</span> <span style="color: red;">(</span><span style="">BinaryTree</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">BinaryTree</span> <span style="">a</span><span style="color: red;">)</span>
</code></pre>
<p>First, there is the straightforward, inefficient version of flatten</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">flatten</span> <span style="color: red;">(</span><span style="">Leaf</span> <span style="">x</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: red;">[</span><span style="">x</span><span style="color: red;">]</span>
<span style="">&gt;</span> <span style="">flatten</span> <span style="color: red;">(</span><span style="">Node</span> <span style="">t1</span> <span style="">t2</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">flatten</span> <span style="">t1</span><span style="color: red;">)</span> <span style="">++</span> <span style="color: red;">(</span><span style="">flatten</span> <span style="">t2</span><span style="color: red;">)</span>
</code></pre>
<p>We can represent our output with difference lists offering O(1) append.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">flatten'</span> <span style="">t</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">t</span> <span style="">[]</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span> <span style="">walk</span> <span style="color: red;">(</span><span style="">Leaf</span> <span style="">x</span><span style="color: red;">)</span>     <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">x</span><span style="">:</span><span style="color: red;">)</span>
<span style="">&gt;</span>         <span style="">walk</span> <span style="color: red;">(</span><span style="">Node</span> <span style="">t1</span> <span style="">t2</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">walk</span> <span style="">t1</span><span style="color: red;">)</span> <span style="">.</span> <span style="color: red;">(</span><span style="">walk</span> <span style="">t2</span><span style="color: red;">)</span>
</code></pre>
<p>And now that we’ve introduced a bunch of first-class functions, let’s see what happens when we defunctionalize them.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">LamBTree</span> <span style="">a</span> <span style="color: red;">=</span> <span style="">LamBTreeA</span> <span style="">a</span> <span style="color: green;">-- (x:)</span>
<span style="">&gt;</span>                 <span style="color: red;">|</span> <span style="">LamBTreeB</span> <span style="color: red;">(</span><span style="">LamBTree</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">LamBTree</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: green;">-- (u . v)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">applyBTree</span> <span style="color: red;">(</span><span style="">LamBTreeA</span> <span style="">x</span><span style="color: red;">)</span>   <span style="">l</span> <span style="color: red;">=</span> <span style="">x</span><span style="">:</span><span style="">l</span>
<span style="">&gt;</span> <span style="">applyBTree</span> <span style="color: red;">(</span><span style="">LamBTreeB</span> <span style="">u</span> <span style="">v</span><span style="color: red;">)</span> <span style="">l</span> <span style="color: red;">=</span> <span style="">applyBTree</span> <span style="">u</span> <span style="color: red;">(</span><span style="">applyBTree</span> <span style="">v</span> <span style="">l</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">flatten_defun</span> <span style="">t</span> <span style="color: red;">=</span> <span style="">applyBTree</span> <span style="color: red;">(</span><span style="">walk</span> <span style="">t</span><span style="color: red;">)</span> <span style="">[]</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span> <span style="">walk</span> <span style="color: red;">(</span><span style="">Leaf</span> <span style="">x</span><span style="color: red;">)</span>     <span style="color: red;">=</span> <span style="">LamBTreeA</span> <span style="">x</span>
<span style="">&gt;</span>         <span style="">walk</span> <span style="color: red;">(</span><span style="">Node</span> <span style="">t1</span> <span style="">t2</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">LamBTreeB</span> <span style="color: red;">(</span><span style="">walk</span> <span style="">t1</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">walk</span> <span style="">t2</span><span style="color: red;">)</span>
</code></pre>
<p>Note how LamBTree looks just like the definition of BinaryTree, because it is a catamorphism, hence a hylomorphism, i.e. a recursive function with a call tree that looks like a BinaryTree or whatever structure you are hylo’ing over. (See Sorting morphisms for a beautiful examples of using this to understand your program (L Augusteijn. AFP 1998)). So walk is pretty much the identity function on trees, and then applyBTree is a flatten function with an accumulating parameter. Ignoring the intermediate structure, then we see defunctionalization as a way to derive accumulating parameters.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">prop_flatten</span> <span style="color: red;">::</span> <span style="">BinaryTree</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span>
<span style="">&gt;</span> <span style="">prop_flatten</span> <span style="">t</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">flatten_defun</span> <span style="">t</span> <span style="">==</span> <span style="">flatten</span> <span style="">t</span><span style="color: red;">)</span>
</code></pre>
<p>*Main&gt; quickCheck prop_flatten OK, passed 100 tests</p>
<p>Defunctionalization as an inverse to church encoding</p>
<p>This was possibly my favorite part of Danvy’s paper, but I unfortunately had to elide it from my talk as being slightly too esoteric for the mixed crowd.</p>
<p>Let us suppose that tuples were not built in to Haskell but we needed to make them ourselves. The data type and destructors would look like this:</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">MyPair</span> <span style="">a</span> <span style="">b</span> <span style="color: red;">=</span> <span style="">P</span> <span style="">a</span> <span style="">b</span> 
<span style="">&gt;</span>                 <span style="color: blue; font-weight: bold;">deriving</span> <span style="color: red;">(</span><span style="">Eq</span><span style="color: red;">,</span><span style="">Show</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">myPair</span> <span style="">x</span> <span style="">y</span>    <span style="color: red;">=</span> <span style="">P</span> <span style="">x</span> <span style="">y</span>
<span style="">&gt;</span> <span style="">myFst</span> <span style="color: red;">(</span><span style="">P</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">x</span>
<span style="">&gt;</span> <span style="">mySnd</span> <span style="color: red;">(</span><span style="">P</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">y</span>
</code></pre>
<p>And we can ask Quickcheck to test extensionality.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">prop_pair</span> <span style="color: red;">::</span> <span style="">MyPair</span> <span style="">Int</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span>
<span style="">&gt;</span> <span style="">prop_pair</span> <span style="">p</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">p</span> <span style="">==</span> <span style="">myPair</span> <span style="color: red;">(</span><span style="">myFst</span> <span style="">p</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">mySnd</span> <span style="">p</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>*Main&gt; quickCheck prop_pair +++ OK, passed 100 tests.</p>
<p>So, if you recall whatever lambda-calculus course you may have taken, we can represent them with only functions. I like having rank-N type available for this.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">type</span> <span style="">ChurchPair</span> <span style="">a</span> <span style="">b</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="color: blue; font-weight: bold;">forall</span> <span style="">c</span> <span style="">.</span> <span style="">a</span> <span style="color: red;">-&gt;</span> <span style="">b</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">a</span> <span style="color: red;">-&gt;</span> <span style="">b</span> <span style="color: red;">-&gt;</span> <span style="">c</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">c</span><span style="color: red;">)</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">churchPair</span> <span style="">x</span> <span style="">y</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">operation</span> <span style="color: red;">-&gt;</span> <span style="">operation</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">churchFst</span>  <span style="">p</span>   <span style="color: red;">=</span> <span style="">p</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">x</span> <span style="">y</span> <span style="color: red;">-&gt;</span> <span style="">x</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">churchSnd</span>  <span style="">p</span>   <span style="color: red;">=</span> <span style="">p</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">x</span> <span style="">y</span> <span style="color: red;">-&gt;</span> <span style="">y</span><span style="color: red;">)</span>
</code></pre>
<p>Rather than make an Arbitrary instance, I’ll settle for reduction rules in this case.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">prop_churchPair</span> <span style="color: red;">::</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span>
<span style="">&gt;</span> <span style="">prop_churchPair</span> <span style="">x</span> <span style="">y</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">x</span> <span style="">==</span> <span style="">churchFst</span> <span style="color: red;">(</span><span style="">churchPair</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">&amp;&amp;</span>
<span style="">&gt;</span>                       <span style="color: red;">(</span><span style="">y</span> <span style="">==</span> <span style="">churchSnd</span> <span style="color: red;">(</span><span style="">churchPair</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>*Main&gt; quickCheck prop_churchPair +++ OK, passed 100 tests.</p>
<p>But now I’ve introduced a bunch of higher-order functions, so we just have to see how they defunctionalize!</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">LamSelector</span> <span style="color: red;">=</span> <span style="">LamFst</span> <span style="color: red;">|</span> <span style="">LamSnd</span>
<span style="">&gt;</span> <span style="">applySelector</span> <span style="color: red;">(</span><span style="">LamFst</span><span style="color: red;">)</span> <span style="">x</span> <span style="">y</span> <span style="color: red;">=</span> <span style="">x</span>
<span style="">&gt;</span> <span style="">applySelector</span> <span style="color: red;">(</span><span style="">LamSnd</span><span style="color: red;">)</span> <span style="">x</span> <span style="">y</span> <span style="color: red;">=</span> <span style="">y</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">LamPair</span> <span style="">a</span> <span style="">b</span> <span style="color: red;">=</span> <span style="">LamPair</span> <span style="">a</span> <span style="">b</span>
<span style="">&gt;</span> <span style="">applyPair</span> <span style="color: red;">(</span><span style="">LamPair</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span> <span style="">operation</span> <span style="color: red;">=</span> <span style="">applySelector</span> <span style="">operation</span> <span style="">x</span> <span style="">y</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">defunPair</span> <span style="">x</span> <span style="">y</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">LamPair</span> <span style="">x</span> <span style="">y</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">defunFst</span>  <span style="">p</span>   <span style="color: red;">=</span> <span style="">applyPair</span> <span style="">p</span> <span style="">LamFst</span>
<span style="">&gt;</span> <span style="">defunSnd</span>  <span style="">p</span>   <span style="color: red;">=</span> <span style="">applyPair</span> <span style="">p</span> <span style="">LamSnd</span>
</code></pre>
<p>You can see that this just reproduces the original, modulo inlining!</p>
<p>Now let’s church-encode BinaryTree as its own fold (or catamorphism, if you like). So we have something to defunctionalize, let’s write churchDepth to calculate the depth of the tree.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">type</span> <span style="">ChurchTree</span> <span style="">a</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">forall</span> <span style="">c</span><span style="">.</span> <span style="color: red;">(</span><span style="">a</span> <span style="color: red;">-&gt;</span> <span style="">c</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">c</span> <span style="color: red;">-&gt;</span> <span style="">c</span> <span style="color: red;">-&gt;</span> <span style="">c</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">c</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">churchLeaf</span> <span style="">x</span>     <span style="color: red;">=</span> <span style="color: red;">\</span><span style="">onLeaf</span> <span style="">onNode</span> <span style="color: red;">-&gt;</span> <span style="">onLeaf</span> <span style="">x</span>
<span style="">&gt;</span> <span style="">churchNode</span> <span style="">t1</span> <span style="">t2</span> <span style="color: red;">=</span> <span style="color: red;">\</span><span style="">onLeaf</span> <span style="">onNode</span> <span style="color: red;">-&gt;</span> <span style="">onNode</span> <span style="color: red;">(</span><span style="">t1</span> <span style="">onLeaf</span> <span style="">onNode</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">t2</span> <span style="">onLeaf</span> <span style="">onNode</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">churchFold</span> <span style="">onLeaf</span> <span style="">onNode</span> <span style="">t</span> <span style="color: red;">=</span> <span style="">t</span> <span style="">onLeaf</span> <span style="">onNode</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">churchDepth</span> <span style="">t</span> <span style="color: red;">=</span> <span style="">t</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">x</span> <span style="color: red;">-&gt;</span> <span class="hs-num">0</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">d1</span> <span style="">d2</span> <span style="color: red;">-&gt;</span> <span class="hs-num">1</span> <span style="">+</span> <span style="color: red;">(</span><span style="">d1</span> <span style="">`max`</span> <span style="">d2</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>Acknowledging that the church encoding is just the fold, we can defunctionalize the fold over any functor to recover the data type. Anyhow…</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">LamLeaf</span> <span style="color: red;">=</span> <span style="">LamLeaf</span> <span style="color: green;">-- onLeaf</span>
<span style="">&gt;</span> <span style="">applyLeaf</span> <span style="">LamLeaf</span> <span style="">x</span> <span style="color: red;">=</span> <span class="hs-num">0</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">LamNode</span> <span style="color: red;">=</span> <span style="">LamNode</span> <span style="color: green;">-- onNode</span>
<span style="">&gt;</span> <span style="">applyNode</span> <span style="">LamNode</span> <span style="">d1</span> <span style="">d2</span> <span style="color: red;">=</span> <span class="hs-num">1</span> <span style="">+</span> <span style="color: red;">(</span><span style="">d1</span> <span style="">`max`</span> <span style="">d2</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">LamTree</span> <span style="">a</span> <span style="color: red;">=</span> <span style="">LamTreeLeaf</span> <span style="">a</span>   <span style="color: green;">-- churchLeaf</span>
<span style="">&gt;</span>                <span style="color: red;">|</span> <span style="">LamTreeNode</span> <span style="color: red;">(</span><span style="">LamTree</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">LamTree</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: green;">-- churchNode</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">applyTree</span> <span style="color: red;">(</span><span style="">LamTreeLeaf</span> <span style="">x</span><span style="color: red;">)</span>     <span style="">onLeaf</span> <span style="">onNode</span> <span style="color: red;">=</span> <span style="">applyLeaf</span> <span style="">onLeaf</span> <span style="">x</span>
<span style="">&gt;</span> <span style="">applyTree</span> <span style="color: red;">(</span><span style="">LamTreeNode</span> <span style="">t1</span> <span style="">t2</span><span style="color: red;">)</span> <span style="">onLeaf</span> <span style="">onNode</span> <span style="color: red;">=</span> 
<span style="">&gt;</span>   <span style="">applyNode</span> <span style="">onNode</span> <span style="color: red;">(</span><span style="">applyTree</span> <span style="">t1</span> <span style="">onLeaf</span> <span style="">onNode</span><span style="color: red;">)</span>
<span style="">&gt;</span>                    <span style="color: red;">(</span><span style="">applyTree</span> <span style="">t2</span> <span style="">onLeaf</span> <span style="">onNode</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">depth_defun</span> <span style="">t</span> <span style="color: red;">=</span> <span style="">applyTree</span> <span style="">t</span> <span style="">LamLeaf</span> <span style="">LamNode</span>
</code></pre>
<p>applyTree is just fold over a tree, as promised, and we’ve recovered the tree data structure. Defunctionalize your continuation</p>
<p>Suppose you have a first-order (boring!) program. You can’t have any fun until you find a way to introduce some first-class functions. A classic way to introduce a gratuitous number is to convert your code into continuation-passing style. Let’s try it.</p>
<p>This is Danvy’s ‘s example of a parser to recognize the language 0^n 1^n. It is written with an auxiliary function in the Maybe monad to simulate throwing an exception as soon as we can reject the string.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">recognize</span> <span style="color: red;">::</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span>
<span style="">&gt;</span> <span style="">recognize</span> <span style="">xs</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">walk</span> <span style="">xs</span> <span style="color: blue; font-weight: bold;">of</span> <span style="">Just</span> <span style="">[]</span> <span style="color: red;">-&gt;</span> <span style="">True</span>
<span style="">&gt;</span>                                <span style="color: blue; font-weight: bold;">_</span>       <span style="color: red;">-&gt;</span> <span style="">False</span> 
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span> 
<span style="">&gt;</span>     <span style="">walk</span> <span style="color: red;">::</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="">Maybe</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="color: red;">(</span><span class="hs-num">0</span><span style="">:</span><span style="">xs'</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">do</span> <span style="">remaining</span> <span style="color: red;">&lt;-</span> <span style="">walk</span> <span style="">xs'</span>
<span style="">&gt;</span>                       <span style="color: blue; font-weight: bold;">case</span> <span style="">remaining</span> <span style="color: blue; font-weight: bold;">of</span> <span style="color: red;">(</span><span class="hs-num">1</span><span style="">:</span><span style="">ys</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">Just</span> <span style="">ys</span>
<span style="">&gt;</span>                                         <span style="color: blue; font-weight: bold;">_</span>      <span style="color: red;">-&gt;</span> <span style="">Nothing</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="">xs</span> <span style="color: red;">=</span> <span style="">Just</span> <span style="">xs</span> <span style="color: green;">-- otherwise</span>
</code></pre>
<p>The audience insisted that I test this, because it is a bit of a weird way to write a trivial function.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">prop_recognize1</span> <span style="">n</span> <span style="color: red;">=</span> <span style="">recognize</span> <span style="color: red;">(</span><span style="">take</span> <span style="">n</span> <span style="color: red;">(</span><span style="">repeat</span> <span class="hs-num">0</span><span style="color: red;">)</span> <span style="">++</span> <span style="">take</span> <span style="">n</span> <span style="color: red;">(</span><span style="">repeat</span> <span class="hs-num">1</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">prop_recognize2</span> <span style="">m</span> <span style="">n</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">m</span> <span style="">&gt;=</span> <span class="hs-num">0</span> <span style="">&amp;&amp;</span> <span style="">n</span> <span style="">&gt;=</span> <span class="hs-num">1</span> <span style="">&amp;&amp;</span> <span style="">m</span> <span style="">/=</span> <span style="">n</span><span style="color: red;">)</span> 
<span style="">&gt;</span>    <span style="">==&gt;</span> <span style="color: red;">(</span><span style="">not</span> <span style="color: red;">(</span><span style="">recognize</span> <span style="color: red;">(</span><span style="">take</span> <span style="">m</span> <span style="color: red;">(</span><span style="">repeat</span> <span class="hs-num">0</span><span style="color: red;">)</span> <span style="">++</span> <span style="">take</span> <span style="">n</span> <span style="color: red;">(</span><span style="">repeat</span> <span class="hs-num">1</span><span style="color: red;">)</span><span style="color: red;">)</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p><em>Main&gt; quickCheck prop_recognize1 +++ OK, passed 100 tests. </em>Main&gt; quickCheck prop_recognize2 +++ OK, passed 100 tests.</p>
<p>Now if we CPS it, we no longer need the Maybe because we can just discard the continuation and return False.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">recognize'</span> <span style="color: red;">::</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span>
<span style="">&gt;</span> <span style="">recognize'</span> <span style="">xs</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">xs</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">xs'</span> <span style="color: red;">-&gt;</span> <span style="">[]</span> <span style="">==</span> <span style="">xs'</span><span style="color: red;">)</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="color: red;">::</span> <span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="color: red;">[</span><span style="">Int</span><span style="color: red;">]</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">Bool</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="color: red;">(</span><span class="hs-num">0</span><span style="">:</span><span style="">xs'</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">xs'</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">rem</span> <span style="color: red;">-&gt;</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">rem</span> <span style="color: blue; font-weight: bold;">of</span> <span style="color: red;">(</span><span class="hs-num">1</span><span style="">:</span><span style="">ys</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">k</span> <span style="">ys</span>
<span style="">&gt;</span>                                                    <span style="color: blue; font-weight: bold;">_</span>      <span style="color: red;">-&gt;</span> <span style="">False</span><span style="color: red;">)</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="">xs</span>      <span style="">k</span> <span style="color: red;">=</span> <span style="">k</span> <span style="">xs</span> <span style="color: green;">-- otherwise</span>
</code></pre>
<p>And defunctionalizing it</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">Continuation</span> <span style="color: red;">=</span> <span style="">ContToplevel</span>     <span style="color: green;">-- (\xs' -&gt; null xs')</span>
<span style="">&gt;</span>                   <span style="color: red;">|</span> <span style="">ContRecurse</span> <span style="">Continuation</span> <span style="color: green;">-- (\remaining -&gt; ... )</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">applyCont</span> <span style="">ContToplevel</span>    <span style="">l</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">l</span><span style="">==</span><span style="">[]</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">applyCont</span> <span style="color: red;">(</span><span style="">ContRecurse</span> <span style="">k</span><span style="color: red;">)</span> <span style="">l</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">case</span> <span style="">l</span> <span style="color: blue; font-weight: bold;">of</span> <span style="color: red;">(</span><span class="hs-num">1</span><span style="">:</span><span style="">ys</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">applyCont</span> <span style="">k</span> <span style="">ys</span>
<span style="">&gt;</span>                                         <span style="color: blue; font-weight: bold;">_</span>      <span style="color: red;">-&gt;</span> <span style="">False</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">recognize''</span> <span style="">xs</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">xs</span> <span style="">ContToplevel</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="color: red;">(</span><span class="hs-num">0</span><span style="">:</span><span style="">xs'</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">xs'</span> <span style="color: red;">(</span><span style="">ContRecurse</span> <span style="">k</span><span style="color: red;">)</span>
<span style="">&gt;</span>     <span style="">walk</span> <span style="">xs</span>      <span style="">k</span> <span style="color: red;">=</span> <span style="">applyCont</span> <span style="">k</span> <span style="">xs</span>
</code></pre>
<p>But now we can look and see that the continuation data structure is just implementing natural numbers, so we replace it by an Int.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">applyNumCont</span> <span class="hs-num">0</span> <span style="">[]</span>     <span style="color: red;">=</span> <span style="">True</span>
<span style="">&gt;</span> <span style="">applyNumCont</span> <span style="">k</span> <span style="color: red;">(</span><span class="hs-num">1</span><span style="">:</span><span style="">xs</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">applyNumCont</span> <span style="color: red;">(</span><span style="">k</span><span style="color: green;">-</span><span class="hs-num">1</span><span style="color: red;">)</span> <span style="">xs</span>
<span style="">&gt;</span> <span style="">applyNumCont</span> <span style="color: blue; font-weight: bold;">_</span> <span style="color: blue; font-weight: bold;">_</span>      <span style="color: red;">=</span> <span style="">False</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">recognize_final</span> <span style="">xs</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">xs</span> <span class="hs-num">0</span>
<span style="">&gt;</span>   <span style="color: blue; font-weight: bold;">where</span> <span style="">walk</span> <span style="color: red;">(</span><span class="hs-num">0</span><span style="">:</span><span style="">xs'</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">walk</span> <span style="">xs'</span> <span style="color: red;">(</span><span style="">k</span><span style="">+</span><span class="hs-num">1</span><span style="color: red;">)</span>
<span style="">&gt;</span>         <span style="">walk</span> <span style="">xs</span>      <span style="">k</span> <span style="color: red;">=</span> <span style="">k</span> <span style="">xs</span>
</code></pre>
<p>We get the program we should have written in the first place.</p>
<p>I didn’t get to the rest of this in my talk, and anyhow it is most interesting to people who play with operational semantics a lot. This last bit is from Danvy’s paper On Evaluation Contexts, Continuations, and The Rest of Computation from the continuation workshop in 2004.</p>
<p>We have a simple arithmetic language, and two ways of giving it a semantics: We can either reduce the expression a single small step, using reduceAllTheWay to normalize it, or we can eval the expression directly to a result.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">Exp</span> <span style="color: red;">=</span> <span style="">Value</span> <span style="">Int</span>
<span style="">&gt;</span>          <span style="color: red;">|</span> <span style="">Add</span> <span style="">Exp</span> <span style="">Exp</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">reduce</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">Exp</span>
<span style="">&gt;</span> <span style="">reduce</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v2</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">Value</span> <span style="color: red;">(</span><span style="">v1</span> <span style="">+</span> <span style="">v2</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">reduce</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="">e2</span>        <span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">reduce</span> <span style="">e2</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">reduce</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span>         <span style="">e2</span>        <span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">Add</span> <span style="color: red;">(</span><span style="">reduce</span> <span style="">e1</span><span style="color: red;">)</span> <span style="">e2</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">reduceAllTheWay</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">reduceAllTheWay</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">reduceAllTheWay</span> <span style="">e</span> <span style="color: red;">=</span> <span style="">reduceAllTheWay</span> <span style="color: red;">(</span><span style="">reduce</span> <span style="">e</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">eval</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">eval</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span>   <span style="color: red;">=</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">eval</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span> <span style="">e2</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: red;">(</span><span style="">eval</span> <span style="">e1</span><span style="color: red;">)</span> <span style="">+</span> <span style="color: red;">(</span><span style="">eval</span> <span style="">e2</span><span style="color: red;">)</span>
</code></pre>
<p>Now we CPS both of them</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">reduceCPS</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">a</span>
<span style="">&gt;</span> <span style="">reduceCPS</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v2</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">k</span> <span style="color: red;">(</span><span style="">Value</span> <span style="color: red;">(</span><span style="">v1</span> <span style="">+</span> <span style="">v2</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">reduceCPS</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="">e2</span>        <span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">reduceCPS</span> <span style="">e2</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">e</span> <span style="color: red;">-&gt;</span> <span style="">k</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="">e</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">reduceCPS</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span>         <span style="">e2</span>        <span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">reduceCPS</span> <span style="">e1</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">e</span> <span style="color: red;">-&gt;</span> <span style="">k</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e</span> <span style="">e2</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">reduceAllTheWayCPS</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">a</span>
<span style="">&gt;</span> <span style="">reduceAllTheWayCPS</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">k</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">reduceAllTheWayCPS</span> <span style="">e</span>         <span style="">k</span> <span style="color: red;">=</span> <span style="">reduceCPS</span> <span style="">e</span> <span style="color: red;">(</span><span style="">flip</span> <span style="">reduceAllTheWayCPS</span> <span style="">k</span><span style="color: red;">)</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">evalCPS</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">a</span>
<span style="">&gt;</span> <span style="">evalCPS</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span>   <span style="">k</span> <span style="color: red;">=</span> <span style="">k</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">evalCPS</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span> <span style="">e2</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">evalCPS</span> <span style="">e1</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">v1</span> <span style="color: red;">-&gt;</span> <span style="">evalCPS</span> <span style="">e2</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">v2</span> <span style="color: red;">-&gt;</span> <span style="">k</span> <span style="color: red;">(</span><span style="">v1</span> <span style="">+</span> <span style="">v2</span><span style="color: red;">)</span><span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>CPS code is easier to read when I write it like this</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">evalCPS'</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="color: red;">(</span><span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: red;">-&gt;</span> <span style="">a</span>
<span style="">&gt;</span> <span style="">evalCPS'</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span>   <span style="">k</span> <span style="color: red;">=</span> <span style="">k</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">evalCPS'</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span> <span style="">e2</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">evalCPS</span> <span style="">e1</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">v1</span> <span style="color: red;">-&gt;</span>
<span style="">&gt;</span>                          <span style="">evalCPS</span> <span style="">e2</span> <span style="color: red;">(</span><span style="color: red;">\</span><span style="">v2</span> <span style="color: red;">-&gt;</span>
<span style="">&gt;</span>                          <span style="">k</span> <span style="color: red;">(</span><span style="">v1</span><span style="">+</span><span style="">v2</span><span style="color: red;">)</span>  <span style="color: red;">)</span><span style="color: red;">)</span>
</code></pre>
<p>and I might as well admit that Haskell already has this in the bag</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="">evalCPS''</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">Cont</span> <span style="">a</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">evalCPS''</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span>   <span style="color: red;">=</span> <span style="">return</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">evalCPS''</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span> <span style="">e2</span><span style="color: red;">)</span> <span style="color: red;">=</span> <span style="color: blue; font-weight: bold;">do</span> <span style="">v1</span> <span style="color: red;">&lt;-</span> <span style="">evalCPS''</span> <span style="">e1</span>
<span style="">&gt;</span>                            <span style="">v2</span> <span style="color: red;">&lt;-</span> <span style="">evalCPS''</span> <span style="">e2</span>
<span style="">&gt;</span>                            <span style="">return</span> <span style="color: red;">(</span><span style="">v1</span> <span style="">+</span> <span style="">v2</span><span style="color: red;">)</span>
</code></pre>
<p>Now we defunctionalize both semantics</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">ContReduce</span> <span style="color: red;">=</span> <span style="">ContReduce</span>  <span style="color: green;">-- (flip reduceAllTheWay)</span>
<span style="">&gt;</span>                 <span style="color: red;">|</span> <span style="">ContAddV1</span> <span style="">Exp</span> <span style="">ContReduce</span> <span style="color: green;">-- (\e -&gt; Add (Value v1) e)</span>
<span style="">&gt;</span>                 <span style="color: red;">|</span> <span style="">ContAddE2</span> <span style="">ContReduce</span> <span style="">Exp</span> <span style="color: green;">-- (\e -&gt; Add e e2)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">applyContReduce</span> <span style="color: red;">::</span> <span style="">ContReduce</span> <span style="color: red;">-&gt;</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">Exp</span>
<span style="">&gt;</span> <span style="">applyContReduce</span> <span style="">ContReduce</span> <span style="">e</span> <span style="color: red;">=</span> <span style="">e</span>
<span style="">&gt;</span> <span style="">applyContReduce</span> <span style="color: red;">(</span><span style="">ContAddV1</span> <span style="">v1</span> <span style="">k</span><span style="color: red;">)</span> <span style="">e</span> <span style="color: red;">=</span> <span style="">applyContReduce</span> <span style="">k</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">v1</span> <span style="">e</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">applyContReduce</span> <span style="color: red;">(</span><span style="">ContAddE2</span> <span style="">k</span> <span style="">e2</span><span style="color: red;">)</span> <span style="">e</span> <span style="color: red;">=</span> <span style="">applyContReduce</span> <span style="">k</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e</span> <span style="">e2</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">reduceCPSdefun</span> <span style="color: red;">::</span> <span style="">Exp</span> <span style="color: red;">-&gt;</span> <span style="">ContReduce</span> <span style="color: red;">-&gt;</span> <span style="">Exp</span>
<span style="">&gt;</span> <span style="">reduceCPSdefun</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v2</span><span style="color: red;">)</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">applyContReduce</span> <span style="">k</span> <span style="color: red;">(</span><span style="">Value</span> <span style="color: red;">(</span><span style="">v1</span> <span style="">+</span> <span style="">v2</span><span style="color: red;">)</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">reduceCPSdefun</span> <span style="color: red;">(</span><span style="">Add</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="">e2</span>        <span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">reduceCPSdefun</span> <span style="">e2</span> <span style="color: red;">(</span><span style="">ContAddV1</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v1</span><span style="color: red;">)</span> <span style="">k</span><span style="color: red;">)</span>
<span style="">&gt;</span> <span style="">reduceCPSdefun</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span>         <span style="">e2</span>        <span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">reduceCPSdefun</span> <span style="">e1</span> <span style="color: red;">(</span><span style="">ContAddE2</span> <span style="">k</span> <span style="">e2</span><span style="color: red;">)</span>
</code></pre>
<p>The data type ContReduce is the now-common notion of an “evaluation context” which some researchers prefer because it separates the important rules about how terms are reduced from the rules that just tell you where in a term reduction happens.</p>
<p>Next…</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">data</span> <span style="">ContEval</span> <span style="color: red;">=</span> <span style="">ContEval</span> <span style="color: green;">-- toplevel</span>
<span style="">&gt;</span>               <span style="color: red;">|</span> <span style="">ContE1</span> <span style="">ContEval</span> <span style="">Exp</span>
<span style="">&gt;</span>               <span style="color: red;">|</span> <span style="">ContE2</span> <span style="">Int</span> <span style="">ContEval</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">applyContEval</span> <span style="color: red;">::</span> <span style="">ContEval</span> <span style="color: red;">-&gt;</span> <span style="">Int</span> <span style="color: red;">-&gt;</span> <span style="">Int</span>
<span style="">&gt;</span> <span style="">applyContEval</span> <span style="color: red;">(</span><span style="">ContEval</span><span style="color: red;">)</span> <span style="">v</span> <span style="color: red;">=</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">applyContEval</span> <span style="color: red;">(</span><span style="">ContE1</span> <span style="">k</span> <span style="">e2</span><span style="color: red;">)</span> <span style="">v1</span> <span style="color: red;">=</span> <span style="">evalCPSdefun</span> <span style="">e2</span> <span style="color: red;">(</span><span style="">ContE2</span> <span style="">v1</span> <span style="">k</span><span style="color: red;">)</span> 
<span style="">&gt;</span> <span style="">applyContEval</span> <span style="color: red;">(</span><span style="">ContE2</span> <span style="">v1</span> <span style="">k</span><span style="color: red;">)</span> <span style="">v2</span> <span style="color: red;">=</span> <span style="">applyContEval</span> <span style="">k</span> <span style="color: red;">(</span><span style="">v1</span> <span style="">+</span> <span style="">v2</span><span style="color: red;">)</span>
<span style="">&gt;</span> 
<span style="">&gt;</span> <span style="">evalCPSdefun</span> <span style="color: red;">(</span><span style="">Value</span> <span style="">v</span><span style="color: red;">)</span>   <span style="">k</span> <span style="color: red;">=</span> <span style="">applyContEval</span> <span style="">k</span> <span style="">v</span>
<span style="">&gt;</span> <span style="">evalCPSdefun</span> <span style="color: red;">(</span><span style="">Add</span> <span style="">e1</span> <span style="">e2</span><span style="color: red;">)</span> <span style="">k</span> <span style="color: red;">=</span> <span style="">evalCPSdefun</span> <span style="">e1</span> <span style="color: red;">(</span><span style="">ContE1</span> <span style="">k</span> <span style="">e2</span><span style="color: red;">)</span>
</code></pre>
<p>Hey it looks like almost the same thing! The difference is in how we interpret the data structure. In the previous case, applyContReduce just used it for navigation. In this case, applyContEval calls back into evalCPSdefun to keep the evaluation rolling.</p>
<p>If, like myself, you liked this because you feel there is important and interesting structure underlying operational semantics that is hidden by its many superficial forms, then you’ll probably like this additional reading:</p>
<pre><code>* Modularity and implementation of mathematical operational semantics. M Jaskelioff, N Ghani, G Hutton. MSFP 2008.
* Fold and unfold for program semantics. G Hutton. ICFP 1998.</code></pre>
<p>And I leave you with my hidden instances of arbitrary…</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">instance</span> <span style="">Arbitrary</span> <span style="">a</span> <span style="color: red;">=&gt;</span> <span style="">Arbitrary</span> <span style="color: red;">(</span><span style="">BinaryTree</span> <span style="">a</span><span style="color: red;">)</span> <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>   <span style="">arbitrary</span> <span style="color: red;">=</span> <span style="">oneof</span> <span style="color: red;">[</span><span style="">liftM</span> <span style="">Leaf</span> <span style="">arbitrary</span><span style="color: red;">,</span> <span style="">liftM2</span> <span style="">Node</span> <span style="">arbitrary</span> <span style="">arbitrary</span><span style="color: red;">]</span>
</code></pre>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span style="">&gt;</span> <span style="color: blue; font-weight: bold;">instance</span> <span style="color: red;">(</span><span style="">Arbitrary</span> <span style="">a</span><span style="color: red;">,</span> <span style="">Arbitrary</span> <span style="">b</span><span style="color: red;">)</span> <span style="color: red;">=&gt;</span> <span style="">Arbitrary</span> <span style="color: red;">(</span><span style="">MyPair</span> <span style="">a</span> <span style="">b</span><span style="color: red;">)</span> <span style="color: blue; font-weight: bold;">where</span>
<span style="">&gt;</span>   <span style="">arbitrary</span> <span style="color: red;">=</span> <span style="">liftM2</span> <span style="">myPair</span> <span style="">arbitrary</span> <span style="">arbitrary</span>
</code></pre>
<div class="references">

</div>
